---
title: "Using and adding IAMC data checks"
author: "Jan Philipp Dietrich"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using and adding IAMC data checks}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Purpose and Functionality

The iamc R package is a collection of R tools provided by the Integrated Assessment Modeling Consortium (IAMC) for data consistency checks. It can be used to make sure that a data set is in line with rules set by a given project. This rules can be for instance a given naming convention or unit conventions for variables, but also qualitative measures such as that certain variables lie between certain bounds. Besides that the data can be compared to given validation data.


## A simple example

The package comes with a small example data set `example_REMIND` supposed to be checked against a configuration 'example_CFG' (strongly reduced for demonstration purposes). To show the functionality of the package some mistakes have been introduced into the example data set. To find these mistakes you can feed the input data set to the check function `iamCheck`:

```{r, echo=TRUE}
library(iamc)
iamCheck(example_REMIND, cfg="example_CFG")
```

This returns information about the checks performed and the problems found in the data. 

## Introduce customized project settings

Setting `cfg="example_CFG"` in the example above makes sure, that the data is analyzed based on a rule set specified in 'example_CFG'. It is possible to use other project settings instead. Another way is to load existing cfg project settings and customize it. In the following example we take the existing example_CFG config, introduce a unknown variable `Population_OtherName` by renaming `Population`. Second example sets a new maximum value for "FE"  to 200:

```{r, echo=TRUE}
# first example
# load cfg
cfg <- iamProjectConfig("example_CFG")
# modify cfg
cfg$variable[cfg$variable=="Population"] <- "Population_OtherName"
# run check with new cfg
iamCheck(example_REMIND, cfg=cfg)

# second example
# load cfg
cfg <- iamProjectConfig("example_CFG")
# modify cfg
cfg$max[cfg$variable=="FE"] <- 200
# run check with new cfg
iamCheck(example_REMIND, cfg=cfg)
```

## Validate data against historical and other reference data

In addidion all data can be validated against historical and other reference data if realated data are available. A collection of global historical and other reference data are provided by the package and used as default validation data ( i.e. 'val="IAMC"). The data and reference data are plotted into one graph. As well the consitency is checked by some indicators like the absolute value, the gradient and the trend. These results are summarised in a traffic light system. The results of the validation are stored in the 'pdf=validation.pdf' if a name for the pdf is choosen.  

```{r, echo=TRUE}
# provide a name for the pdf so that the validation is run 
iamCheck(example_REMIND, pdf="validation.pdf", cfg="example_CFG")

```

## Adding own checks

It is possible and encouraged to add own checks. All check functions should have a name starting with "check" and use values available in iamCheck, which
are currently x (the provided input data to be tested as quitte object), mx (the same data as magclass object), cfg (the project configuration) and val (the validation data). 

The function needs to return a list of two objects: a character "message" which is the message showing up at the end of the test with the place holder "%#" for the number of elements for which the test failed and a character vector "failed" identifying the objects for which the test failed.

By default iamCheck will only look for checks which are available within the package, but with the argument `globalenv = TRUE` it will also search the global environment for functions. 

To add for instance a unit check, you can write a function `checkUnits` following the rules mentioned above and run `iamCheck` with `globalenv = TRUE`:

```{r, echo=TRUE}
library(iamc)

checkUnits <- function(x, cfg) {
  x_var_unit <- unique(paste(x$variable, x$unit, sep=" | unit: "))
  cfg_var_unit <- unique(paste(cfg$variable, cfg$unit, sep=" | unit: "))
  failed <- x_var_unit[!(x_var_unit %in% cfg_var_unit)]
  return(list(message="%# variables are reported in the wrong unit",
              failed=failed))
}

iamCheck(example_REMIND, cfg="example_CFG", globalenv=TRUE)

# run again with modified cfg to trigger unit warning
example2 <-example_REMIND
levels(example2$unit)[2] <- "weird_unit"

iamCheck(example2, cfg="example_CFG", globalenv=TRUE)

```

As soon as the new check is working it would be nice if you could add it to the package so that others could use it as well.



